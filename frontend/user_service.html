<!doctype html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Music Platform | Users</title>
  <style>
    /* (CSS isti kao tvoj — nisam ga dirao) */
    :root{
      --bg0:#070b16; --bg1:#0b1330; --card:#0c1736;
      --line:#20305f; --line2:#25386d; --text:#eaf1ff; --muted:#a9b7e2;
      --blue:#4f7cff; --blue2:#2f5bff; --ok:#68d391; --bad:#fc8181; --info:#90cdf4;
      --shadow: 0 14px 40px rgba(0,0,0,.35); --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text); min-height:100vh; display:flex; align-items:center; justify-content:center;
      padding:24px;
      background:
        radial-gradient(1000px 600px at 20% 10%, rgba(79,124,255,.18), transparent 55%),
        radial-gradient(900px 600px at 80% 30%, rgba(47,91,255,.14), transparent 55%),
        linear-gradient(135deg, var(--bg0), var(--bg1));
    }
    .container{ max-width: 980px; width:100%; }
    .header{ text-align:center; margin-bottom:22px; }
    .header h1{
      margin:0; font-size:32px; letter-spacing:.2px;
      background: linear-gradient(135deg, #b8c8ff, #4f7cff 60%, #2f5bff);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
    }
    .header .subtitle{ margin-top:8px; color:var(--muted); font-size:14px; }

    .tabs{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin: 14px 0 16px; }
    .tab{
      padding:12px 18px; border-radius: 999px; border: 1px solid var(--line);
      background: rgba(12,23,54,.65); cursor:pointer; transition: .2s ease;
      font-weight:600; color:var(--text); user-select:none;
    }
    .tab:hover{ border-color: rgba(79,124,255,.7); transform: translateY(-1px); }
    .tab.active{
      background: linear-gradient(135deg, rgba(79,124,255,.95), rgba(47,91,255,.95));
      border-color: rgba(79,124,255,.9); box-shadow: 0 8px 26px rgba(79,124,255,.25);
    }

    .alert{
      display:none; padding: 12px 14px; border-radius: 12px; border: 1px solid transparent;
      margin: 0 auto 14px; max-width: 680px; font-size: 14px;
    }
    .alert.show{ display:block; }
    .alert-success{ background: rgba(104,211,145,.12); border-color: rgba(104,211,145,.28); color: var(--ok); }
    .alert-error{ background: rgba(252,129,129,.10); border-color: rgba(252,129,129,.28); color: var(--bad); }
    .alert-info{ background: rgba(144,205,244,.10); border-color: rgba(144,205,244,.28); color: var(--info); }

    .card{
      max-width: 680px; margin: 0 auto; background: rgba(12,23,54,.78);
      border: 1px solid var(--line); border-radius: var(--radius);
      padding: 26px; box-shadow: var(--shadow); backdrop-filter: blur(10px);
    }
    .card h2{ margin: 0 0 18px; font-size: 22px; letter-spacing:.2px; }
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 640px){ .grid-2{ grid-template-columns:1fr; } }

    .form-group{ margin-bottom: 16px; }
    label{
      display:block; margin-bottom: 8px; color: #d7e3ff; font-size: 13px; font-weight: 700;
      letter-spacing:.2px;
    }
    input{
      width:100%; padding: 12px 14px; border-radius: 12px; border: 1px solid var(--line2);
      background: rgba(7,11,22,.85); color: var(--text); font-size: 15px; outline:none;
      transition: .2s ease;
    }
    input:focus{ border-color: rgba(79,124,255,.9); box-shadow: 0 0 0 4px rgba(79,124,255,.14); }
    .helper{ margin-top: 6px; font-size: 12px; color: var(--muted); }
    .btn{
      width:100%; padding: 13px 14px; border-radius: 12px;
      border: 1px solid rgba(79,124,255,.7);
      background: linear-gradient(135deg, rgba(79,124,255,.95), rgba(47,91,255,.95));
      color: white; font-size: 15px; font-weight: 800; letter-spacing:.2px;
      cursor:pointer; transition: .2s ease; margin-top: 6px;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 26px rgba(79,124,255,.22); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    .btn-secondary{ background: rgba(12,23,54,.65); border-color: var(--line2); margin-top: 10px; }
    .btn-secondary:hover{ box-shadow:none; border-color: rgba(79,124,255,.55); }

    .btn-success{
      background: linear-gradient(135deg, rgba(104,211,145,.95), rgba(56,161,105,.95));
      border-color: rgba(104,211,145,.55);
    }
    .btn-success:hover{ box-shadow: 0 10px 26px rgba(104,211,145,.18); }

    .view{ display:none; }
    .view.active{ display:block; }

    .user-info{
      border: 1px solid var(--line2); border-radius: 14px;
      background: rgba(7,11,22,.70); padding: 14px; margin-bottom: 12px;
    }
    .row{
      display:flex; justify-content:space-between; gap: 10px;
      padding: 9px 0; border-bottom: 1px solid rgba(37,56,109,.55);
    }
    .row:last-child{ border-bottom:none; }
    .label{ color: var(--muted); font-size: 13px; }
    .value{ color: var(--text); font-weight: 700; font-size: 13px; text-align:right; }

    .badge{
      display:inline-block; padding: 4px 10px; border-radius: 999px;
      font-size: 11px; font-weight: 900; text-transform: uppercase;
      border: 1px solid transparent;
    }
    .badge-user{ background: rgba(144,205,244,.12); border-color: rgba(144,205,244,.25); color: var(--info); }
    .badge-admin{ background: rgba(79,124,255,.14); border-color: rgba(79,124,255,.30); color: #b8c8ff; }

    .password-strength{
      height: 5px; background: rgba(37,56,109,.55);
      border-radius: 999px; overflow:hidden; margin-top: 8px;
    }
    .password-strength-bar{ height:100%; width:0%; transition:.2s ease; }
    .strength-weak{ width:33%; background: var(--bad); }
    .strength-medium{ width:66%; background: #f6ad55; }
    .strength-strong{ width:100%; background: var(--ok); }

    .api-pill{
      display:inline-flex; gap:8px; align-items:center; padding: 6px 10px;
      border-radius: 999px; border: 1px solid var(--line2);
      background: rgba(12,23,54,.55); color: var(--muted);
      font-size: 12px; margin-top: 8px;
    }
    .dot{ width:8px;height:8px;border-radius:999px;background:rgba(169,183,226,.6); }
    .dot.ok{ background: var(--ok); }
    .dot.bad{ background: var(--bad); }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Music Platform</h1>
      <div class="subtitle">User Authentication (Register, Login, Validation, MongoDB)</div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabLogin">Prijava</div>
      <div class="tab" id="tabRegister">Registracija</div>
      <div class="tab" id="tabProfile" style="display:none;">Profil</div>
    </div>

    <div id="alertBox" class="alert"></div>

    <div id="viewLogin" class="view active">
      <div class="card">
        <h2>Prijavite se</h2>
        <form id="formLogin">
          <div class="form-group">
            <label for="loginEmail">Email</label>
            <input type="email" id="loginEmail" placeholder="vas@email.com" required />
          </div>
          <div class="form-group">
            <label for="loginPassword">Lozinka</label>
            <input type="password" id="loginPassword" placeholder="Unesite lozinku" required />
          </div>

          <!-- Zaboravljena lozinka (magic link) -->
          <button type="button" class="btn btn-secondary" id="btnForgot">Zaboravljena lozinka?</button>

          <button type="submit" class="btn" id="btnLogin">Prijavi se</button>
        </form>
      </div>
    </div>

    <div id="viewRegister" class="view">
      <div class="card">
        <h2>Kreirajte nalog</h2>
        <form id="formRegister">
          <div class="grid-2">
            <div class="form-group">
              <label for="regFirstName">Ime</label>
              <input type="text" id="regFirstName" placeholder="Marko" required />
            </div>
            <div class="form-group">
              <label for="regLastName">Prezime</label>
              <input type="text" id="regLastName" placeholder="Marković" required />
            </div>
          </div>

          <div class="form-group">
            <label for="regUsername">Korisničko ime</label>
            <input type="text" id="regUsername" placeholder="marko_markovic" required />
            <div class="helper">3-30 karaktera (slova, brojevi, _)</div>
          </div>

          <div class="form-group">
            <label for="regEmail">Email</label>
            <input type="email" id="regEmail" placeholder="vas@email.com" required />
          </div>

          <div class="form-group">
            <label for="regPassword">Lozinka</label>
            <input type="password" id="regPassword" placeholder="Minimum 8 karaktera" required />
            <div class="password-strength">
              <div class="password-strength-bar" id="passwordStrengthBar"></div>
            </div>
            <div class="helper">Mora sadržati velika i mala slova i brojeve</div>
          </div>

          <button type="submit" class="btn" id="btnRegister">Registruj se</button>
        </form>
      </div>
    </div>

    <div id="viewProfile" class="view">
      <div class="card">
        <h2>Moj profil</h2>

        <div id="userInfo" class="user-info">
          <div class="row">
            <span class="label">Ime i prezime:</span>
            <span class="value" id="profileName">-</span>
          </div>
          <div class="row">
            <span class="label">Korisničko ime:</span>
            <span class="value" id="profileUsername">-</span>
          </div>
          <div class="row">
            <span class="label">Email:</span>
            <span class="value" id="profileEmail">-</span>
          </div>
          <div class="row">
            <span class="label">Uloga:</span>
            <span class="value"><span id="profileRole" class="badge badge-user">user</span></span>
          </div>
          <div class="row">
            <span class="label">Kreiran:</span>
            <span class="value" id="profileCreated">-</span>
          </div>
        </div>

        <div class="api-pill" title="Proverava API (gateway/users) health endpoint">
          <span class="dot" id="apiDot"></span>
          <span id="apiStatusText">API status: nepoznato</span>
        </div>

        <button class="btn btn-success" id="btnGoBrowse">Dalje</button>
        <button class="btn btn-secondary" id="btnLogout">Odjavi se</button>
      </div>
    </div>
  </div>

  <script src="/assets/auth.js"></script>

  <script>
    // --- Tabs ---
    document.getElementById('tabLogin').onclick = () => switchTab('login');
    document.getElementById('tabRegister').onclick = () => switchTab('register');
    document.getElementById('tabProfile').onclick = () => switchTab('profile');

    function switchTab(tab) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

      if (tab === 'login') {
        document.getElementById('viewLogin').classList.add('active');
        document.getElementById('tabLogin').classList.add('active');
      } else if (tab === 'register') {
        document.getElementById('viewRegister').classList.add('active');
        document.getElementById('tabRegister').classList.add('active');
      } else {
        document.getElementById('viewProfile').classList.add('active');
        document.getElementById('tabProfile').classList.add('active');
        loadProfile();
        checkApiHealth();
      }
    }

    // --- Alerts ---
    function showAlert(message, type = 'info') {
      const box = document.getElementById('alertBox');
      box.className = `alert alert-${type} show`;
      box.textContent = message;
      setTimeout(() => box.classList.remove('show'), 5000);
    }

    // --- Password strength ---
    document.getElementById('regPassword').addEventListener('input', (e) => {
      const password = e.target.value;
      const bar = document.getElementById('passwordStrengthBar');

      if (!password) { bar.className = 'password-strength-bar'; return; }

      let strength = 0;
      if (password.length >= 8) strength++;
      if (/[A-Z]/.test(password)) strength++;
      if (/[a-z]/.test(password)) strength++;
      if (/[0-9]/.test(password)) strength++;

      if (strength <= 2) bar.className = 'password-strength-bar strength-weak';
      else if (strength === 3) bar.className = 'password-strength-bar strength-medium';
      else bar.className = 'password-strength-bar strength-strong';
    });

    // --- Login ---
    document.getElementById('formLogin').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('btnLogin');
      btn.disabled = true; btn.textContent = 'Prijava...';

      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;

      try {
        await MPAuth.login(email, password);

        showAlert('Uspešna prijava.', 'success');

        document.getElementById('tabProfile').style.display = 'block';
        document.getElementById('tabLogin').style.display = 'none';
        document.getElementById('tabRegister').style.display = 'none';

        setTimeout(() => switchTab('profile'), 400);
      } catch (err) {
        showAlert(err.message || 'Greška pri prijavi', 'error');
      } finally {
        btn.disabled = false; btn.textContent = 'Prijavi se';
      }
    });

    // --- Forgot password (magic link) ---
    document.getElementById('btnForgot').onclick = () => {
      window.location.href = '/forgot-password.html';
    };

    // --- Register ---
    document.getElementById('formRegister').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('btnRegister');
      btn.disabled = true; btn.textContent = 'Registracija...';

      const userData = {
        firstName: document.getElementById('regFirstName').value.trim(),
        lastName: document.getElementById('regLastName').value.trim(),
        username: document.getElementById('regUsername').value.trim(),
        email: document.getElementById('regEmail').value.trim(),
        password: document.getElementById('regPassword').value
      };

      try {
        await MPAuth.register(userData);
        showAlert('Registracija uspešna. Sada se možete prijaviti.', 'success');
        document.getElementById('formRegister').reset();
        document.getElementById('passwordStrengthBar').className = 'password-strength-bar';
        setTimeout(() => switchTab('login'), 700);
      } catch (err) {
        showAlert(err.message || 'Greška pri registraciji', 'error');
      } finally {
        btn.disabled = false; btn.textContent = 'Registruj se';
      }
    });

    // --- Profile ---
    function loadProfile() {
      const u = MPAuth.getUser();
      if (!u) { switchTab('login'); return; }

      document.getElementById('profileName').textContent = `${u.firstName || ''} ${u.lastName || ''}`.trim() || '-';
      document.getElementById('profileUsername').textContent = u.username || '-';
      document.getElementById('profileEmail').textContent = u.email || '-';

      const roleUp = MPAuth.roleOf(u);
      const badge = document.getElementById('profileRole');

      if (MPAuth.isAdmin(u)) {
        badge.textContent = roleUp || 'A';
        badge.className = 'badge badge-admin';
      } else {
        badge.textContent = (roleUp || 'USER').toLowerCase();
        badge.className = 'badge badge-user';
      }

      const createdDate = u.createdAt ? new Date(u.createdAt).toLocaleDateString('sr-RS', {
        year: 'numeric', month: 'long', day: 'numeric'
      }) : '-';
      document.getElementById('profileCreated').textContent = createdDate;
    }

    // --- API health indicator ---
    async function checkApiHealth() {
      const dot = document.getElementById('apiDot');
      const text = document.getElementById('apiStatusText');

      dot.className = 'dot';
      text.textContent = 'API status: proveravam...';

      try {
        const ok = await MPAuth.healthCheck();
        dot.className = ok ? 'dot ok' : 'dot bad';
        text.textContent = ok ? 'API status: OK' : 'API status: nije OK';
      } catch {
        dot.className = 'dot bad';
        text.textContent = 'API status: nije dostupan (proveri gateway/users)';
      }
    }

    // --- Buttons ---
    document.getElementById('btnGoBrowse').onclick = () => {
      if (!MPAuth.getUser()) {
        showAlert('Niste ulogovani.', 'error');
        switchTab('login');
        return;
      }
      window.location.href = 'index.html';
    };

    document.getElementById('btnLogout').onclick = () => {
      MPAuth.clearAuth();
      document.getElementById('tabProfile').style.display = 'none';
      document.getElementById('tabLogin').style.display = 'block';
      document.getElementById('tabRegister').style.display = 'block';
      showAlert('Odjava uspešna.', 'info');
      switchTab('login');
    };

    // --- On load ---
    window.addEventListener('load', () => {
      const saved = MPAuth.getUser();
      if (saved) {
        document.getElementById('tabProfile').style.display = 'block';
        document.getElementById('tabLogin').style.display = 'none';
        document.getElementById('tabRegister').style.display = 'none';
        switchTab('profile');
      }
    });
  </script>
</body>
</html>
